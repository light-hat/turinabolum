from django.contrib.auth.models import User
from django.test import TestCase

from core.models import Incident, IncidentMalware, Malware


class MalwareModelTest(TestCase):
    def setUp(self):
        self.user = User.objects.create_user(username="testuser", password="testpass")
        self.incident = Incident.objects.create(
            title="Test Incident",
            description="This is a test incident",
            status="New",
            severity="High",
            classification="Malware",
            confidentiality="Internal",
            created_by=self.user,
        )
        self.malware_data = {
            "name": "IcedID",
            "description": "Banking Trojan",
            "type": "Trojan",
            "aliases": "Bokbot",
        }

    def test_create_malware(self):
        malware = Malware.objects.create(**self.malware_data)
        self.assertEqual(malware.name, "IcedID")
        self.assertEqual(malware.type, "Trojan")
        self.assertEqual(malware.aliases, "Bokbot")

    def test_malware_str_representation(self):
        malware = Malware.objects.create(**self.malware_data)
        self.assertEqual(str(malware), "IcedID")

    def test_create_incident_malware(self):
        malware = Malware.objects.create(**self.malware_data)
        incident_malware_data = {
            "incident": self.incident,
            "malware": malware,
            "version": "1.0",
            "evidence": "Test evidence",
        }
        incident_malware = IncidentMalware.objects.create(**incident_malware_data)
        self.assertEqual(incident_malware.incident, self.incident)
        self.assertEqual(incident_malware.malware, malware)
        self.assertEqual(incident_malware.version, "1.0")

    def test_incident_malware_str_representation(self):
        malware = Malware.objects.create(**self.malware_data)
        incident_malware = IncidentMalware.objects.create(
            incident=self.incident, malware=malware
        )
        expected_str = f"{incident_malware.incident} - {incident_malware.malware}"
        self.assertEqual(str(incident_malware), expected_str)
